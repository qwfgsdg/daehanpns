generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String                @id @default(uuid())
  email                String?               @unique
  phone                String                @unique
  password             String?
  name                 String
  nickname             String?               @unique
  gender               Gender?
  birthDate            DateTime?
  profileImage         String?
  provider             AuthProvider          @default(LOCAL)
  providerId           String?               @unique
  affiliateCode        String
  isActive             Boolean               @default(true)
  fcmToken             String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  deletedAt            DateTime?
  banReason            String?
  isBanned             Boolean               @default(false)
  lastLoginAt          DateTime?
  memberType           MemberType            @default(STOCK)
  showCoinRooms        Boolean               @default(false)
  managerId            String?
  referralSource       ReferralSource?
  manager              Admin?                @relation("ManagerRelation", fields: [managerId], references: [id])
  chatParticipants     ChatParticipant[]
  sentMessages         ChatMessage[]         @relation("ChatMessageSender")
  memos                MemberMemo[]
  notifications        Notification[]
  notificationSettings NotificationSetting[]
  popupDismissals      PopupDismissal[]
  reports              Report[]
  subscriptions        Subscription[]
  memberTypeHistories  MemberTypeHistory[]
  managerHistories     ManagerHistory[]      @relation("UserManagerHistory")

  @@index([email])
  @@index([phone])
  @@index([affiliateCode])
  @@index([createdAt])
  @@index([providerId])
  @@index([nickname])
  @@index([memberType])
  @@index([managerId])
}

model Admin {
  id              String            @id @default(uuid())
  loginId         String            @unique
  password        String
  realName        String
  salesName       String
  email           String?
  phone           String?
  tier            AdminTier         @default(GENERAL)
  isActive        Boolean           @default(true)
  lastLoginAt     DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  deletedAt       DateTime?
  affiliationCode String?           @unique
  referralCode    String?           @unique
  lockedUntil     DateTime?
  loginAttempts   Int               @default(0)
  logoUrl         String?
  region          String?
  createdBy       String?
  parentAdminId   String?
  parent          Admin?            @relation("AdminHierarchy", fields: [parentAdminId], references: [id])
  subordinates    Admin[]           @relation("AdminHierarchy")
  logs            AdminLog[]
  permissions     AdminPermission[]
  managedUsers    User[]            @relation("ManagerRelation")
  managerHistories ManagerHistory[]

  @@index([loginId])
  @@index([tier])
  @@index([affiliationCode])
  @@index([referralCode])
  @@index([parentAdminId])
}

model AdminPermission {
  id         String   @id @default(uuid())
  adminId    String
  permission String
  createdAt  DateTime @default(now())
  admin      Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@unique([adminId, permission])
  @@index([adminId])
}

model AdminLog {
  id             String   @id @default(uuid())
  adminId        String?
  action         String
  target         String?
  targetType     String?
  description    String?
  changesBefore  Json?
  changesAfter   Json?
  status         String?  @default("SUCCESS")
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime @default(now())
  admin          Admin?   @relation(fields: [adminId], references: [id], onDelete: SetNull)

  @@index([adminId])
  @@index([createdAt])
  @@index([targetType])
  @@index([status])
  @@index([target, targetType])
}

model MemberMemo {
  id        String   @id @default(uuid())
  userId    String
  adminId   String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model MemberTypeHistory {
  id                    String     @id @default(uuid())
  userId                String
  fromType              MemberType
  toType                MemberType
  changedBy             String
  reason                String?
  showCoinRoomsChanged  Boolean    @default(false)
  previousShowCoinRooms Boolean?
  newShowCoinRooms      Boolean?
  createdAt             DateTime   @default(now())
  user                  User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([changedBy])
}

model ManagerHistory {
  id            String   @id @default(uuid())
  userId        String
  fromManagerId String?
  toManagerId   String
  changedBy     String
  reason        String?
  createdAt     DateTime @default(now())
  user          User     @relation("UserManagerHistory", fields: [userId], references: [id], onDelete: Cascade)
  toManager     Admin    @relation(fields: [toManagerId], references: [id])

  @@index([userId])
  @@index([toManagerId])
  @@index([createdAt])
  @@index([changedBy])
}

model ChatRoom {
  id              String              @id @default(uuid())
  type            ChatType
  category        RoomCategory        @default(STOCK)
  name            String?
  description     String?
  image           String?
  isActive        Boolean             @default(true)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  deletedAt       DateTime?
  maxParticipants Int?
  messages        ChatMessage[]
  participants    ChatParticipant[]
  pinnedMessages  ChatPinnedMessage[]

  @@index([type])
  @@index([category])
  @@index([createdAt])
  @@index([isActive])
}

model ChatParticipant {
  id             String    @id @default(uuid())
  roomId         String
  userId         String
  ownerType      OwnerType @default(MEMBER)
  isViceOwner    Boolean   @default(false)
  joinedAt       DateTime  @default(now())
  lastReadAt     DateTime?
  leftAt         DateTime?
  isKicked       Boolean   @default(false)
  isShadowBanned Boolean   @default(false)
  kickReason     String?
  kickedAt       DateTime?
  kickedBy       String?
  shadowBannedAt DateTime?
  shadowBannedBy String?
  room           ChatRoom  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
  @@index([roomId])
  @@index([userId])
  @@index([isKicked])
  @@index([isShadowBanned])
}

model ChatMessage {
  id            String     @id @default(uuid())
  roomId        String
  senderId      String
  senderType    SenderType @default(USER)
  content       String
  fileUrl       String?
  fileName      String?
  fileSize      Int?
  isDeleted     Boolean    @default(false)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  deletedAt     DateTime?
  deletedBy     String?
  fileDeletedAt DateTime?
  room          ChatRoom   @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender        User       @relation("ChatMessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([senderId])
  @@index([senderType])
  @@index([createdAt])
  @@index([isDeleted])
  @@index([fileDeletedAt])
  @@index([createdAt, senderId, senderType, isDeleted])
  @@index([roomId, createdAt, isDeleted])
}

model ChatPinnedMessage {
  id        String   @id @default(uuid())
  roomId    String
  messageId String
  content   String
  pinnedBy  String
  pinnedAt  DateTime @default(now())
  room      ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
}

model BlockedKeyword {
  id        String   @id @default(uuid())
  keyword   String   @unique
  createdAt DateTime @default(now())
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  category  NotifCategory
  title     String
  body      String
  data      Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model NotificationSetting {
  id        String        @id @default(uuid())
  userId    String
  category  NotifCategory
  isEnabled Boolean       @default(true)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category])
  @@index([userId])
}

model Faq {
  id        String   @id @default(uuid())
  question  String
  answer    String
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([order])
}

model Report {
  id          String       @id @default(uuid())
  reporterId  String
  targetType  String
  targetId    String
  reason      String
  description String?
  status      ReportStatus @default(PENDING)
  adminNote   String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  reporter    User         @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  @@index([reporterId])
  @@index([targetType])
  @@index([status])
  @@index([createdAt])
}

model Banner {
  id        String    @id @default(uuid())
  position  BannerPos
  title     String?
  imageUrl  String
  linkUrl   String?
  order     Int       @default(0)
  isActive  Boolean   @default(true)
  startDate DateTime?
  endDate   DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([position])
  @@index([order])
  @@index([isActive])
}

model Popup {
  id         String           @id @default(uuid())
  title      String
  content    String
  imageUrl   String?
  linkUrl    String?
  isActive   Boolean          @default(true)
  startDate  DateTime?
  endDate    DateTime?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  dismissals PopupDismissal[]

  @@index([isActive])
}

model PopupDismissal {
  id          String      @id @default(uuid())
  popupId     String
  userId      String
  type        DismissType
  dismissedAt DateTime    @default(now())
  expiresAt   DateTime?
  popup       Popup       @relation(fields: [popupId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([popupId, userId])
  @@index([popupId])
  @@index([userId])
  @@index([expiresAt])
}

model Expert {
  id            String         @id @default(uuid())
  name          String
  profileImage  String?
  description   String?
  vipRoomId     String?
  vvipRoomId    String?
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  subscriptions Subscription[]

  @@index([isActive])
}

model Subscription {
  id             String             @id @default(uuid())
  userId         String
  status         SubscriptionStatus @default(ACTIVE)
  startDate      DateTime
  endDate        DateTime
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  cancelledAt    DateTime?
  cancelledBy    String?
  createdBy      String
  durationMonths Int
  expertId       String
  roomType       RoomType
  depositName    String?
  depositAmount  Int?
  adminMemo      String?
  expert         Expert             @relation(fields: [expertId], references: [id], onDelete: Cascade)
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expertId])
  @@index([status])
  @@index([endDate])
}

model DiscountEvent {
  id           String   @id @default(uuid())
  name         String
  description  String?
  discountRate Int
  startDate    DateTime
  endDate      DateTime
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
}

model AppVersion {
  id            String   @id @default(uuid())
  platform      Platform
  version       String
  buildNumber   Int
  isForceUpdate Boolean  @default(false)
  updateMessage String?
  downloadUrl   String?
  createdAt     DateTime @default(now())

  @@unique([platform, version])
  @@index([platform])
}

enum AuthProvider {
  LOCAL
  GOOGLE
  KAKAO
}

enum Gender {
  MALE
  FEMALE
}

enum AdminTier {
  INTEGRATED
  CEO
  MIDDLE
  GENERAL
}

enum ChatType {
  ONE_TO_N
  ONE_TO_ONE
  TWO_WAY
}

enum OwnerType {
  OWNER
  VICE_OWNER
  MEMBER
}

enum NotificationType {
  SYSTEM
  CHAT
  SUBSCRIPTION
}

enum NotifCategory {
  CHAT_MESSAGE
  CHAT_ROOM_INVITE
  CHAT_ROOM_KICK
  SUBSCRIPTION_APPROVED
  SUBSCRIPTION_REJECTED
  SUBSCRIPTION_EXPIRED
  SYSTEM_NOTICE
  SYSTEM_EVENT
}

enum ReportStatus {
  PENDING
  PROCESSING
  RESOLVED
  REJECTED
}

enum BannerPos {
  HOME_TOP
  HOME_MIDDLE
  HOME_BOTTOM
  CHAT_TOP
  COMMUNITY_TOP
}

enum DismissType {
  TODAY
  WEEK
  FOREVER
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum RoomType {
  VIP
  VVIP
}

enum Platform {
  WEB
  IOS
  ANDROID
}

enum MemberType {
  STOCK
  COIN
  HYBRID
}

enum RoomCategory {
  STOCK
  COIN
}

enum ReferralSource {
  CODE
  SEARCH
  INVITE_LINK
}

enum SenderType {
  USER
  ADMIN
}
